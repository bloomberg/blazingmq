<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libbmq: bmqa/bmqa_messageeventbuilder.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">libbmq<span id="projectnumber">&#160;40e14399e705713c51abe1c821a1e29c69a719c0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('bmqa__messageeventbuilder_8h.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#namespaces">Namespaces</a>  </div>
  <div class="headertitle"><div class="title">bmqa_messageeventbuilder.h File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Provide a builder for <a class="el" href="classBloombergLP_1_1bmqa_1_1MessageEvent.html">bmqa::MessageEvent</a> objects.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;<a class="el" href="bmqa__message_8h_source.html">bmqa_message.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="bmqa__messageevent_8h_source.html">bmqa_messageevent.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="bmqt__resultcode_8h_source.html">bmqt_resultcode.h</a>&gt;</code><br />
<code>#include &lt;bsl_memory.h&gt;</code><br />
</div>
<p><a href="bmqa__messageeventbuilder_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBloombergLP_1_1bmqa_1_1MessageEventBuilder.html">BloombergLP::bmqa::MessageEventBuilder</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">A builder for <code><a class="el" href="classBloombergLP_1_1bmqa_1_1MessageEvent.html">MessageEvent</a></code> objects.  <a href="classBloombergLP_1_1bmqa_1_1MessageEventBuilder.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="namespaces" name="namespaces"></a>
Namespaces</h2></td></tr>
<tr class="memitem:namespaceBloombergLP" id="r_namespaceBloombergLP"><td class="memItemLeft" align="right" valign="top">namespace &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceBloombergLP.html">BloombergLP</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:namespaceBloombergLP_1_1bmqa" id="r_namespaceBloombergLP_1_1bmqa"><td class="memItemLeft" align="right" valign="top">namespace &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceBloombergLP_1_1bmqa.html">BloombergLP::bmqa</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>This component implements a mechanism, <a class="el" href="classBloombergLP_1_1bmqa_1_1MessageEventBuilder.html">bmqa::MessageEventBuilder</a>, that can be used for creating message events containing one or multiple messages. The resulting MessageEvent can be sent to the BlazingMQ broker using the <a class="el" href="classBloombergLP_1_1bmqa_1_1Session.html">bmqa::Session</a> (refer to <a class="el" href="bmqa__session_8h.html">bmqa_session.h</a> for details).</p>
<p>The builder holds a <a class="el" href="classBloombergLP_1_1bmqa_1_1MessageEvent.html">bmqa::MessageEvent</a> under construction, and provides methods to return a reference to the current message (in order to set its various members), as well as to append a new message. Once the application is done, the builder provides a method to get the message event that has been constructed. See <a class="el" href="bmqa__messageeventbuilder_8h.html#bmqa_messageeventbuilder_usage">Usage</a> section for more details.</p>
<p>Note that publishing events containing multiple messages may be more efficient than events limited to a single message for applications that send large volume of small messages.</p>
<h1><a class="anchor" id="bmqa_messageeventbuilder_usage"></a>
Usage</h1>
<ul>
<li>An instance of <a class="el" href="classBloombergLP_1_1bmqa_1_1MessageEventBuilder.html">bmqa::MessageEventBuilder</a> (the builder) can be used to create multiple <a class="el" href="classBloombergLP_1_1bmqa_1_1MessageEvent.html">bmqa::MessageEvent</a>'s, as long as the instance is reset in between. This reset is preferably to do right after sending the event to guarantee that all user resources bound to the <a class="el" href="classBloombergLP_1_1bmqa_1_1MessageEvent.html">bmqa::MessageEvent</a> (e.g. CorrelationIds with user's shared_ptr) are kept no longer than expected (e.g. until related ACK event is received). The recommended approach is to create one instance of the builder and use that throughout the lifetime of the task (if the task is multi-threaded, an instance per thread must be created and maintained). See <a class="el" href="bmqa__messageeventbuilder_8h.html#bmqa_messageeventbuilder_ex1">usage example 1</a> for an illustration.</li>
<li>The lifetime of an instance of the builder is bound by the <a class="el" href="classBloombergLP_1_1bmqa_1_1Session.html">bmqa::Session</a> from which it was created. In other words, <a class="el" href="classBloombergLP_1_1bmqa_1_1Session.html">bmqa::Session</a> instance must outlive the builder instance.</li>
<li>If it is desired to post the same <a class="el" href="classBloombergLP_1_1bmqa_1_1Message.html">bmqa::Message</a> to different queues, <a class="el" href="classBloombergLP_1_1bmqa_1_1MessageEventBuilder.html#a434abd51be733b1410de56faa256f9a4">bmqa::MessageEventBuilder::packMessage</a> can be called multiple times in a row with different queue IDs. The builder will append the previously packed message with the new queue ID to the underlying message event. Note that after calling <a class="el" href="classBloombergLP_1_1bmqa_1_1MessageEventBuilder.html#a434abd51be733b1410de56faa256f9a4">bmqa::MessageEventBuilder::packMessage</a>, the message keeps all the attributes (payload, properties, etc) that were previously set (except for the <code>correlationId</code> which must be set explicitly for each individual message). If desired, any attribute can be tweaked before being packing the message again. Refer to <a class="el" href="bmqa__messageeventbuilder_8h.html#bmqa_messageeventbuilder_ex2">usage example 2</a> for an illustration.</li>
</ul>
<h2><a class="anchor" id="bmqa_messageeventbuilder_ex1"></a>
Example 1 - Basic Usage</h2>
<div class="fragment"><div class="line"><span class="comment">// Note that error handling is omitted below for the sake of brevity</span></div>
<div class="line"> </div>
<div class="line">bmqa::Session session;</div>
<div class="line">    <span class="comment">// Session start up logic omitted for brevity.</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Obtain a valid instance of message properties.</span></div>
<div class="line">bmqa::MessageProperties properties;</div>
<div class="line">session.loadMessageProperties(&amp;properties);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Set common properties that will be applicable to all messages sent by</span></div>
<div class="line"><span class="comment">// this application.</span></div>
<div class="line"><span class="keywordtype">int</span> rc = properties.setPropertyAsChar(</div>
<div class="line">                                <span class="stringliteral">&quot;encoding&quot;</span>,</div>
<div class="line">                                <span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span><span class="keyword">&gt;</span>(MyEncodingEnum::e_BER));</div>
<div class="line"> </div>
<div class="line">rc = properties.setPropertyAsString(<span class="stringliteral">&quot;producerId&quot;</span>, <span class="stringliteral">&quot;MyUniqueId&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Obtain a valid instance of message event builder.</span></div>
<div class="line">bmqa::MessageEventBuilder builder;</div>
<div class="line">session.loadMessageEventBuilder(&amp;builder);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create and post a message event containing 1 message.  Associate</span></div>
<div class="line"><span class="comment">// properties with this message.</span></div>
<div class="line">bmqa::Message&amp; msg = builder.startMessage();</div>
<div class="line"> </div>
<div class="line">msg.setCorrelationId(myCorrelationId);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Set payload (where &#39;myPayload&#39; is of type &#39;bdlbb::Blob&#39;)</span></div>
<div class="line">msg.setDataRef(&amp;myPayload);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Set current timestamp as one of the properties.</span></div>
<div class="line">rc = properties.setPropertyAsInt64(</div>
<div class="line">             <span class="stringliteral">&quot;timestamp&quot;</span>,</div>
<div class="line">             bdlt::EpochUtil::convertToTimeT64(bdlt::CurrentTime::now()));</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Set properties.</span></div>
<div class="line">msg.setPropertiesRef(&amp;properties);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Pack the message.</span></div>
<div class="line">rc = builder.packMessage(myQueueId);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Post message event</span></div>
<div class="line">rc = session.post(builder.messageEvent());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create and post another message event containing 1 message.</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// bmqa::MessageEventBuilder must be reset before reuse.</span></div>
<div class="line">builder.reset();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Start a new message.</span></div>
<div class="line">bmqa::Message&amp; msg = builder.startMessage();</div>
<div class="line"> </div>
<div class="line">msg.setCorrelationId(myAnotherCorrelationId);</div>
<div class="line">msg.setDataRef(&amp;myAnotherPayload);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// It&#39;s okay (and recommended) to use same properties instance.</span></div>
<div class="line">rc = properties.setPropertyAsInt64(</div>
<div class="line">             <span class="stringliteral">&quot;timestamp&quot;</span>,</div>
<div class="line">             bdlt::EpochUtil::convertToTimeT64(bdlt::CurrentTime::now()));</div>
<div class="line"> </div>
<div class="line">msg.setPropertiesRef(&amp;properties);</div>
<div class="line">rc = builder.packMessage(myAnotherQueueId);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Post second message event</span></div>
<div class="line">rc = session.post(builder.messageEvent());</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Reset the builder to free resources earlier.</span></div>
<div class="line">builder.reset();</div>
</div><!-- fragment --><h2><a class="anchor" id="bmqa_messageeventbuilder_ex2"></a>
Example 2 - Packing multiple messages in a message event</h2>
<div class="fragment"><div class="line"><span class="comment">// Note that error handling is omitted below for the sake of brevity</span></div>
<div class="line"> </div>
<div class="line">bmqa::Session session;</div>
<div class="line"><span class="comment">// Session start up logic omitted for brevity.</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Obtain a valid instance of message properties.</span></div>
<div class="line">bmqa::MessageProperties properties;</div>
<div class="line">session.loadMessageProperties(&amp;properties);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Set common properties that will be applicable to all messages sent by</span></div>
<div class="line"><span class="comment">// this application.</span></div>
<div class="line"><span class="keywordtype">int</span> rc = properties.setPropertyAsChar(</div>
<div class="line">                                <span class="stringliteral">&quot;encoding&quot;</span>,</div>
<div class="line">                                <span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span><span class="keyword">&gt;</span>(MyEncodingEnum::e_BER));</div>
<div class="line"> </div>
<div class="line">rc = properties.setPropertyAsString(<span class="stringliteral">&quot;producerId&quot;</span>, <span class="stringliteral">&quot;MyUniqueId&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Obtain a valid instance of message event builder.</span></div>
<div class="line">bmqa::MessageEventBuilder builder;</div>
<div class="line">session.loadMessageEventBuilder(&amp;builder);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create and post a message event containing 4 messages.</span></div>
<div class="line">bmqa::Message&amp; msg = builder.startMessage();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Pack message #1</span></div>
<div class="line">msg.setCorrelationId(correlationId1);</div>
<div class="line">msg.setDataRef(&amp;payload1);  <span class="comment">// where &#39;payload1&#39; is of type &#39;bdlbb::Blob&#39;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Set current timestamp as one of the properties.</span></div>
<div class="line"><span class="keywordtype">int</span> rc = properties.setPropertyAsInt64(</div>
<div class="line">             <span class="stringliteral">&quot;timestamp&quot;</span>,</div>
<div class="line">             bdlt::EpochUtil::convertToTimeT64(bdlt::CurrentTime::now()));</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Pack the message.</span></div>
<div class="line">rc = builder.packMessage(queueId1);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Pack message #2</span></div>
<div class="line"><span class="comment">// We want to send message #1 to another queue.  In order to do so, we</span></div>
<div class="line"><span class="comment">// just update the correlation ID of message #1.  There is no need to set</span></div>
<div class="line"><span class="comment">// the payload or properties again.  Because &#39;payload1&#39; and &#39;properties&#39;</span></div>
<div class="line"><span class="comment">// objects are being reused for the second message, they should not be</span></div>
<div class="line"><span class="comment">// destroyed before packing the second message.</span></div>
<div class="line"> </div>
<div class="line">msg.setCorrelationId(correlationId2);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Also note that the &quot;timestamp&quot; property for the second message will be</span></div>
<div class="line"><span class="comment">// updated for this message.  There is no need to invoke</span></div>
<div class="line"><span class="comment">// &#39;setPropertiesRef&#39; on the message though.</span></div>
<div class="line">rc = properties.setPropertyAsInt64(</div>
<div class="line">             <span class="stringliteral">&quot;timestamp&quot;</span>,</div>
<div class="line">             bdlt::EpochUtil::convertToTimeT64(bdlt::CurrentTime::now()));</div>
<div class="line"> </div>
<div class="line">rc = builder.packMessage(queueId2);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// &#39;payload1&#39; can be safely destroyed at this point if it will not be</span></div>
<div class="line"><span class="comment">// reused again for another message.</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Pack message #3</span></div>
<div class="line"><span class="comment">// Message #3 has a different payload, no properties and destined to</span></div>
<div class="line"><span class="comment">// &#39;queueId1&#39;.</span></div>
<div class="line">msg.setCorrelationId(correlationId3);</div>
<div class="line">msg.setDataRef(&amp;payload2);  <span class="comment">// where &#39;payload2&#39; is of type &#39;bdlbb::Blob&#39;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// We need to explicitly clear out the associated properties.</span></div>
<div class="line">msg.clearProperties();</div>
<div class="line"> </div>
<div class="line">rc = builder.packMessage(queueId1);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Pack message #4</span></div>
<div class="line"><span class="comment">// Message #4 has different payload and destined to &#39;queueId3&#39;.</span></div>
<div class="line">msg.setCorrelationId(correlationId4);</div>
<div class="line">msg.setDataRef(&amp;payload3);  <span class="comment">// where &#39;payload3&#39; is of type &#39;bdlbb::Blob&#39;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Update &quot;timestamp&quot; property.</span></div>
<div class="line">rc = properties.setPropertyAsInt64(</div>
<div class="line">             <span class="stringliteral">&quot;timestamp&quot;</span>,</div>
<div class="line">             bdlt::EpochUtil::convertToTimeT64(bdlt::CurrentTime::now()));</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Need to associate properties with the message, since they were cleared</span></div>
<div class="line"><span class="comment">// out while packing message #3 above.</span></div>
<div class="line">msg.setPropertiesRef(&amp;properties);</div>
<div class="line"> </div>
<div class="line">rc = builder.packMessage(queueId3);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Post second message event</span></div>
<div class="line">rc = session.post(builder.messageEvent());</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Reset the builder to free resources earlier.</span></div>
<div class="line">builder.reset();</div>
</div><!-- fragment --><h1><a class="anchor" id="bmqa_messageeventbuilder_thread"></a>
Thread Safety</h1>
<p>This component is <em>NOT</em> thread safe. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_e8cd90b45eb8e499a7a689fb69672d2e.html">bmqa</a></li><li class="navelem"><a class="el" href="bmqa__messageeventbuilder_8h.html">bmqa_messageeventbuilder.h</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
